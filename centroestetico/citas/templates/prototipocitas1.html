{% extends "base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendar Cita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <div class="container mt-5">
        <h2 class="mb-4">Agendar Cita</h2>
        <div class="row">
            <div class="col-md-8">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="services-tab" data-bs-toggle="tab"
                            data-bs-target="#services" type="button" role="tab" aria-controls="services"
                            aria-selected="true">
                            Servicios
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="professional-tab" data-bs-toggle="tab"
                            data-bs-target="#professional" type="button" role="tab" aria-controls="professional"
                            aria-selected="false" disabled>
                            Profesional
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="datetime-tab" data-bs-toggle="tab" data-bs-target="#datetime"
                            type="button" role="tab" aria-controls="datetime" aria-selected="false" disabled>
                            Fecha y Hora
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div id="services" class="tab-pane fade show active" role="tabpanel" aria-labelledby="services-tab"
                        data-next-tab="professional">
                        <div class="mt-3">
                            {% for servicio in servicios %}
                            <div class="form-check">
                                <input class="form-check-input servicio-check" type="checkbox" value="{{ servicio.id }}"
                                    id="servicio{{ servicio.id }}" data-nombre="{{ servicio.nombre }}"
                                    data-precio="{{ servicio.precio }}" data-duracion="{{ servicio.duracion }}">
                                <label class="form-check-label" for="servicio{{ servicio.id }}">
                                    {{ servicio.nombre }} - ${{ servicio.precio }} ({{ servicio.duracion }} min)
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <button class="btn btn-primary btn-continuar mt-3" type="button">Continuar</button>
                    </div>
                    <div id="professional" class="tab-pane fade" role="tabpanel" aria-labelledby="professional-tab"
                        data-next-tab="datetime">
                        <div class="mt-3">
                            <div class="form-check">
                                <input class="form-check-input professional-radio" type="radio" name="professional"
                                    id="any-professional" value="any" checked>
                                <label class="form-check-label" for="any-professional">
                                    Cualquier profesional disponible
                                </label>
                            </div>
                            {% for empleado in empleados %}
                            <div class="form-check profesional-item">
                                <input class="form-check-input professional-radio" type="radio" name="professional"
                                    id="professional-{{ empleado.id }}" value="{{ empleado.id }}"
                                    data-servicios="{{ empleado.servicios.all|json_script:" servicios-empleado-"|safe
                                    }}">
                                <label class="form-check-label" for="professional-{{ empleado.id }}">
                                    {{ empleado.nombre }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <button class="btn btn-primary btn-continuar mt-3" type="button">Continuar</button>
                    </div>
                    <div id="datetime" class="tab-pane fade" role="tabpanel" aria-labelledby="datetime-tab">
                        <div class="mt-3">
                            <!-- Selector de fecha y hora -->
                            <p>
                                Contenido para selecci√≥n de fecha y hora (aun tengo por hacer)
                            </p>
                        </div>
                        <button class="btn btn-primary btn-continuar mt-3" type="button">
                            Agendar Cita
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Resumen de la Cita</h5>
                    </div>
                    <div class="card-body">
                        <div id="selectedServices"></div>
                        <div id="selectedProfessional"></div>
                        <div id="selectedDateTime"></div>
                        <hr />
                        <div id="totalSummary"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const servicios = JSON.parse("{{ servicios_json|escapejs }}");
            const empleados = JSON.parse("{{ empleados_json|escapejs }}");
            const serviciosChecks = document.querySelectorAll(".servicio-check");
            const profesionalRadios = document.querySelectorAll(
                ".professional-radio"
            );
            const resumenServicios = document.getElementById("selectedServices");
            const resumenProfesional = document.getElementById(
                "selectedProfessional"
            );
            const resumenDateTime = document.getElementById("selectedDateTime");
            const resumenTotal = document.getElementById("totalSummary");
            const continuarBtns = document.querySelectorAll(".btn-continuar");

            let totalPrecio = 0;
            let totalDuracion = 0;

            serviciosChecks.forEach(check => {
                check.addEventListener('change', () => {
                    actualizarResumenServicios();
                    actualizarProfesionalesDisponibles();
                });
            });

            profesionalRadios.forEach((radio) => {
                radio.addEventListener("change", actualizarResumenProfesional);
            });

            function actualizarResumenServicios() {
                resumenServicios.innerHTML = "<h6>Servicios seleccionados:</h6>";
                totalPrecio = 0;
                totalDuracion = 0;

                serviciosChecks.forEach((check) => {
                    if (check.checked) {
                        const nombre = check.dataset.nombre;
                        const precio = parseFloat(check.dataset.precio);
                        const duracion = parseInt(check.dataset.duracion);

                        resumenServicios.innerHTML += `
                        <p>${nombre} - $${precio.toFixed(
                            2
                        )} (${duracion} min)</p>
                    `;
                        totalPrecio += precio;
                        totalDuracion += duracion;
                    }
                });

                actualizarResumenTotal();
            }

            function actualizarProfesionalesDisponibles() {
                const serviciosSeleccionados = Array.from(document.querySelectorAll('.servicio-check:checked')).map(check => parseInt(check.value));
                const profesionales = document.querySelectorAll('.profesional-item');

                profesionales.forEach(prof => {
                    const radio = prof.querySelector('.professional-radio');
                    if (radio.id === 'any-professional') return; 

                    const serviciosProfesional = JSON.parse(document.getElementById(`servicios-empleado-${radio.value}`).textContent);
                    const puedeRealizarTodos = serviciosSeleccionados.every(servicio => serviciosProfesional.includes(servicio));

                    prof.style.display = puedeRealizarTodos ? '' : 'none';
                });

                
                const profesionalSeleccionado = document.querySelector('.professional-radio:checked');
                if (profesionalSeleccionado && profesionalSeleccionado.closest('.profesional-item').style.display === 'none') {
                    document.getElementById('any-professional').checked = true;
                    actualizarResumenProfesional();
                }
            }
            function actualizarResumenProfesional() {
                const seleccionado = document.querySelector(
                    'input[name="professional"]:checked'
                );
                const profesionalNombre =
                    seleccionado.id === "any-professional"
                        ? "Cualquier profesional disponible"
                        : seleccionado.nextElementSibling.textContent.trim();

                resumenProfesional.innerHTML = `<h6>Profesional:</h6><p>${profesionalNombre}</p>`;
                actualizarResumenTotal();
            }

            function actualizarResumenTotal() {
                resumenTotal.innerHTML = `
                <p><strong>Total: $${totalPrecio.toFixed(2)}</strong></p>
                <p><strong>Duraci√≥n total: ${totalDuracion} min</strong></p>
            `;
            }

            // Manejar la navegaci√≥n entre pesta√±as
            continuarBtns.forEach((btn) => {
                btn.addEventListener("click", function () {
                    const currentTab = this.closest(".tab-pane");
                    const nextTabId = currentTab.dataset.nextTab;
                    if (nextTabId) {
                        const nextTab = document.querySelector(`#${nextTabId}-tab`);
                        nextTab.disabled = false;
                        nextTab.click();
                    }
                });
            });

            // Inicializar el resumen
            actualizarResumenServicios();
            actualizarProfesionalesDisponibles();
        });
    </script>
</body>

</html>
{% endblock %}